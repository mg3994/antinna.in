<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Verifying Login...</title>
    {% if firebase_web_script.is_some() %}
    {{ firebase_web_script.as_ref().unwrap()|safe }}
    {% endif %}
    <script src="/assets/js/tailwindcss.js" defer></script>
    <script src="/assets/js/sweetalert2.js" defer></script>
    <script src="/assets/js/alpinejs.js" defer></script>
</head>
<body class="bg-slate-50 flex items-center justify-center min-h-screen">

<div x-data="verifyHandler()" x-init="completeLogin()" class="text-center p-8 bg-white rounded-3xl shadow-xl max-w-sm w-full border border-gray-100">
    <div x-show="processing">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <h2 class="text-xl font-bold text-gray-800">Finalizing Login</h2>
        <p class="text-sm text-gray-500 mt-2">Connecting to secure session...</p>
    </div>
</div>

<script>
    function verifyHandler() {
        return {
            processing: true,
            fcmToken: null,

            async completeLogin() {
                try {
                    const currentUrl = window.location.href;

                    if (window.fbAuth.isSignInWithEmailLink(currentUrl)) {
                        // 1. Extract email from URL params (Stateless Strategy)
                        const urlParams = new URLSearchParams(window.location.search);
                        let email = urlParams.get('email');

                        // Fallback if URL was tampered with
                        if (!email) {
                            const { value: enteredEmail } = await Swal.fire({
                                title: 'Identity Check',
                                input: 'email',
                                inputLabel: 'Please confirm your email address',
                                allowOutsideClick: false
                            });
                            email = enteredEmail;
                        }

                        if (!email) throw new Error("Email is required.");

                        // 2. Prepare device metadata (FCM + UUID)
                        await this.syncDeviceMetadata();

                        // 3. Finalize Firebase Auth
                        await window.fbAuth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                        const result = await window.fbAuth.signInWithEmailLink(email, currentUrl);

                        // 4. Handshake with Salvo Backend
                        const idToken = await result.user.getIdToken();
                        await this.callBackendAuth(idToken);
                    } else {
                        throw new Error("Invalid or expired session link.");
                    }
                } catch (err) {
                    Swal.fire("Login Failed", err.message, "error").then(() => {
                        window.location.href = "/auth";
                    });
                }
            },

            async syncDeviceMetadata() {
                if (!localStorage.getItem('device_fingerprint')) {
                    localStorage.setItem('device_fingerprint', crypto.randomUUID());
                }
                try {
                    if (window.fbMessaging) {
                        const permission = await Notification.requestPermission();
                        if (permission === 'granted') {
                            const reg = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
                            this.fcmToken = await window.fbMessaging.getToken({
                                vapidKey: window.VAPID_KEY,
                                serviceWorkerRegistration: reg
                            });
                        }
                    }
                } catch (e) { console.warn("Metadata sync failed:", e); }
            },

            async callBackendAuth(idToken) {
                const response = await fetch("/api/authenticate", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        id_token: idToken,
                        fcm_token: this.fcmToken,
                        device_id: localStorage.getItem('device_fingerprint'),
                        user_agent: navigator.userAgent
                    }),
                });

                const result = await response.json();
                if (response.ok) {
                    // Logic: If username is null/missing, they are a new user
                    window.location.href = result.data?.username ? "/users" : "/setup-profile";
                } else {
                    throw new Error(result.error?.brief || "Verification failed");
                }
            }
        }
    }
</script>
</body>
</html>