<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sign In | Salvo</title>
    {% if firebase_web_script.is_some() %}
    {{ firebase_web_script.as_ref().unwrap()|safe }}
    {% endif %}
    <script src="assets/js/tailwindcss.js" defer></script>
    <script src="assets/js/sweetalert2.js" defer></script>
    <script src="assets/js/alpinejs.js" defer></script>
    <style>
        [x-cloak] { display: none !important; }
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.3); }
        .disabled-btn { opacity: 0.5; cursor: not-allowed; pointer-events: none; filter: grayscale(1); }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 to-slate-800 min-h-screen flex items-center justify-center p-4">

<div id="recaptcha-container"></div>

<div x-data="authForm()" x-cloak class="w-full max-w-md">
    <div class="glass p-8 rounded-3xl shadow-2xl space-y-6">

        <div class="text-center">
            <h2 class="text-3xl font-black text-gray-900 tracking-tight">Sign In</h2>
            <p class="text-xs text-gray-500 font-bold uppercase tracking-widest mt-2">Choose your method</p>
        </div>

        <div class="space-y-4">
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">Email Address</label>
                <input x-model="email" type="email" :disabled="loading" placeholder="name@example.com"
                       class="w-full p-4 rounded-xl border border-gray-200 focus:ring-4 focus:ring-blue-100 outline-none transition-all shadow-sm disabled:bg-gray-100" />
            </div>

            {% for p in providers %}
            {% if p.slug == "password" %}
            <button @click="handleEmailLink" :class="{ 'disabled-btn': loading }"
                    class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition active:scale-[0.98] shadow-lg shadow-blue-200">
                <span x-show="!loading">Email Magic Link</span>
                <span x-show="loading">Sending...</span>
            </button>
            {% endif %}
            {% endfor %}
        </div>

        <div class="space-y-3">
            <div class="relative py-2">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-100"></div></div>
                <div class="relative flex justify-center text-[10px] uppercase font-bold text-gray-400"><span class="bg-white px-2">Secure Options</span></div>
            </div>

            <div class="grid grid-cols-1 gap-3">
                {% for p in providers %}
                {% if p.slug != "password" && p.slug != "email_link" %}

                <button @click="loginDispatcher('{{ p.slug }}')"
                        :class="{ 'disabled-btn': loading }"
                        class="flex items-center justify-center p-3 bg-white border border-gray-200 rounded-xl hover:bg-gray-50 transition shadow-sm">

                    {% if p.slug == "google.com" %}
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5 mr-2">
                    {% elif p.slug == "phone" %}
                    <span class="mr-2 text-lg">ðŸ“±</span>
                    {% endif %}

                    <span class="text-sm font-bold">Continue with {{ p.name }}</span>
                </button>

                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    function authForm() {
        return {
            email: "",
            loading: false,
            recaptchaVerifier: null,

            // Global Dispatcher
            async loginDispatcher(slug) {
                if (slug === 'phone') {
                    await this.handlePhoneAuth();
                } else {
                    await this.submitSocial(slug);
                }
            },

            // --- EMAIL LINK LOGIC ---
            async handleEmailLink() {
                if (!this.email) return Swal.fire("Required", "Email is needed for magic links", "info");
                this.loading = true;
                try {
                    const settings = { url: window.location.origin + '/auth/verify-link', handleCodeInApp: true };
                    await window.fbAuth.sendSignInLinkToEmail(this.email, settings);
                    window.localStorage.setItem('emailForSignIn', this.email);
                    Swal.fire("Check Email", "We sent a login link to your inbox!", "success");
                } catch (e) { Swal.fire("Error", e.message, "error"); }
                finally { this.loading = false; }
            },

            // --- PHONE AUTH LOGIC ---
            async handlePhoneAuth() {
                this.loading = true;
                try {
                    // Initialize Recaptcha (Required for Phone Auth)
                    if (!this.recaptchaVerifier) {
                        this.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { 'size': 'invisible' });
                    }

                    // 1. Get Phone Number via Modal
                    const { value: phoneNumber } = await Swal.fire({
                        title: 'Phone Login',
                        html: `
                            <div class="flex flex-col gap-4">
                                <div class="flex gap-2">
                                    <select id="swal-country" class="border p-3 rounded-xl bg-gray-50 text-sm font-bold border-gray-200">
                                        <option value="+91">ðŸ‡®ðŸ‡³ +91</option>
                                        <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
                                        <option value="+44">ðŸ‡¬ðŸ‡§ +44</option>
                                    </select>
                                    <input id="swal-phone" type="tel" class="border p-3 rounded-xl flex-grow outline-none focus:ring-2 focus:ring-blue-400 border-gray-200" placeholder="9876543210">
                                </div>
                            </div>`,
                        confirmButtonText: 'Send Verification Code',
                        showCancelButton: true,
                        confirmButtonColor: '#2563eb',
                        preConfirm: () => {
                            const code = document.getElementById('swal-country').value;
                            const num = document.getElementById('swal-phone').value;
                            if (!num) return Swal.showValidationMessage('Valid number required');
                            return code + num;
                        }
                    });

                    if (!phoneNumber) return;

                    // 2. Ensure Local Persistence is active before final sign-in
                    await window.fbAuth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);


                    // 2. Trigger Firebase SMS
                    const confirmationResult = await window.fbAuth.signInWithPhoneNumber(phoneNumber, this.recaptchaVerifier);

                    // 3. Get OTP via Modal
                    const { value: otp } = await Swal.fire({
                        title: 'Verify Code',
                        input: 'text',
                        inputLabel: 'Enter the 6-digit SMS code',
                        inputPlaceholder: '123456',
                        confirmButtonText: 'Login Now',
                        confirmButtonColor: '#2563eb',
                        showCancelButton: true,
                    });

                    if (otp) {
                        const result = await confirmationResult.confirm(otp);
                        await this.callBackendAuth(await result.user.getIdToken());
                    }
                } catch (e) {
                    console.error("Phone Auth Failure:", e);
                    Swal.fire("Phone Error", e.message, "error");
                } finally { this.loading = false; }
            },

            // --- SOCIAL LOGIN LOGIC ---
            async submitSocial(slug) {
                this.loading = true;
                try {
                    let provider;
                    if (slug === 'google.com') provider = new firebase.auth.GoogleAuthProvider();
                    else if (slug === 'apple.com') provider = new firebase.auth.OAuthProvider('apple.com');
                    // 2. Ensure Local Persistence is active before final sign-in
                    await window.fbAuth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

                    const res = await window.fbAuth.signInWithPopup(provider);
                    await this.callBackendAuth(await res.user.getIdToken());
                } catch (e) { Swal.fire("Login Error", e.message, "error"); }
                finally { this.loading = false; }
            },

            // --- BACKEND VERIFICATION ---
            async callBackendAuth(idToken) {
                const response = await fetch("/api/authenticate", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id_token: idToken }),
                });
                const result = await response.json();
                if (response.ok) {
                    window.location.href = result.data?.username ? "/users" : "/setup-profile";
                } else {
                    Swal.fire("Backend Sync Failed", result.error?.brief || "Verify logic failed", "error");
                }
            }
        };
    }
</script>
</body>
</html>